<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,
               initial-scale=1.0,
               viewport-fit=cover,
               user-scalable=no" />
<title>Innerworld</title>

<style>
/* your existing innerworld CSS unchanged */
html, body {
  margin: 0; padding: 0;
  width: 100vw; height: 100vh;
  overflow: hidden; background: black; touch-action: none;
}
#gameCanvas {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: calc(90vh - env(safe-area-inset-bottom));
}
#uiButtons {
  position: fixed;
  bottom: calc(1.5vh + env(safe-area-inset-bottom));
  left: 50%; transform: translateX(-50%);
  display: flex; gap: 1.5vh;
  z-index: 9999; pointer-events:none;
  font-family: sans-serif; color: white;
}
.ui-btn { pointer-events:auto; }
#joystick { position:absolute; width:120px;height:120px;
  border-radius:50%; background:rgba(255,255,255,0.15);
  display:none; touch-action:none; z-index:5000;
}
#stick { width:60px;height:60px;border-radius:50%;
  background:rgba(255,255,255,0.4); position:absolute;left:30px;top:30px;
}
#fadeOverlay {
  position:fixed; inset:0; background:black; opacity:0;
  pointer-events:none; transition:opacity .4s; z-index:12000;
}
</style>
</head>

<body>

<canvas id="gameCanvas"></canvas>

<div id="uiButtons">
  <div id="defaultUI">UI — walk up to things…</div>
  <button id="harvestButton" class="ui-btn">HARVEST BLOSSOM</button>

  <button id="fightButton" class="ui-btn">FIGHT</button>
  <button id="runButton" class="ui-btn">RUN</button>

  <button id="hitButton" class="ui-btn">HIT</button>
  <button id="smackButton" class="ui-btn">SMACK</button>
  <button id="punchButton" class="ui-btn">PUNCH</button>
  <button id="kickButton" class="ui-btn">KICK</button>
</div>

<div id="joystick"><div id="stick"></div></div>

<div id="fadeOverlay"></div>

<script>
// ======================================================
// LOAD SAVE (tile type + rarity + player start)
// ======================================================
const raw = localStorage.getItem("innerworld_entry");
if (!raw) {
  alert("No game save found. Returning to map...");
  window.location.href = "index.html";
}
const entry = JSON.parse(raw);

const TILE_TYPE   = entry.tile.type;      // plains / forest / hills / home
const TILE_RARITY = entry.tile.rarity;    // common / uncommon / rare
const PLAYER_START = entry.playerStart;   // {x,y}

// ======================================================
// CANVAS
// ======================================================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight * 0.90;
}
resize();
window.addEventListener("resize", resize);

let currentTime = 0;

// ======================================================
// ASSETS (DYNAMIC)
// ======================================================
const bg = new Image();
bg.src = `innerworld/${TILE_TYPE}_${TILE_RARITY}_bg.png`;

const collisionImg = new Image();
collisionImg.src = `collision/${TILE_TYPE}_${TILE_RARITY}_col.png`;

const blossomImg = new Image();
blossomImg.src = "item_blossom.png";

const monsterIdleImg = new Image();
monsterIdleImg.src = "monster_starwolf_idle.png";

const monsterAttackImg = new Image();
monsterAttackImg.src = "monster_starwolf_attack.png";

const monsterHurtImg = new Image();
monsterHurtImg.src = "monster_starwolf_hurt.png";

const frames = ["player1.png","player2.png","player3.png"].map(src => {
  const i = new Image(); i.src = src; return i;
});

// ======================================================
// COLLISION MAP
// ======================================================
const colCanvas = document.createElement("canvas");
const colCtx = colCanvas.getContext("2d");
let collisionReady = false;

collisionImg.onload = () => {
  colCanvas.width = collisionImg.width;
  colCanvas.height = collisionImg.height;
  colCtx.drawImage(collisionImg, 0, 0);
  collisionReady = true;
};

function pixelBlocked(x,y){
  if(!collisionReady) return false;
  if(x<0 || y<0 || x>=colCanvas.width || y>=colCanvas.height) return true;
  const d = colCtx.getImageData(x,y,1,1).data;
  return d[0]<50 && d[1]<50 && d[2]<50;
}

function circleBlocked(cx,cy,r){
  const n=10;
  for(let i=0;i<n;i++){
    const a = (i/n)*Math.PI*2;
    const px = cx + Math.cos(a)*r;
    const py = cy + Math.sin(a)*r;
    if(pixelBlocked(px,py)) return true;
  }
  return false;
}

// ======================================================
// PLAYER
// ======================================================
let DEBUG_HITBOX = false;

let player = {
  x: PLAYER_START.x,
  y: PLAYER_START.y,
  speed: 180,
  frame: 0,
  frameTimer: 0,
  scale: 0.20,
  facingLeft:false,
  moving:false,
  hitR:40,
  hitOffsetY:10,
  hpMax:20,
  hp:20,
  hitFlash:0,
  lungeOffsetX:0,
  lungeOffsetY:0
};

// ======================================================
// (THE REST OF YOUR INNERWORLD JS—
// JOYSTICK, MONSTER, ITEMS, ROAM, COMBAT, UI MODES,
// UPDATE, DRAW, ETC — REMAINS 100% UNCHANGED)
// ======================================================

// ---- SNIPPED FOR BREVITY -----
// (Everything below remains exactly the same as your current file.)
// ---- YOU PASTE YOUR EXISTING REMAINING CODE HERE ----

</script>
</body>
</html>

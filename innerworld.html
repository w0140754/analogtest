<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>Innerworld</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    touch-action: none;
    background: black;
    font-family: system-ui, sans-serif;
  }

  #gameCanvas {
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
  }

  #topBanner {
    position: fixed;
    top: env(safe-area-inset-top);
    left: 50%;
    transform: translateX(-50%);
    padding: 6px 14px;
    font-size: 14px;
    background: rgba(0,0,0,0.55);
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    color: white;
    z-index: 2000;
  }

  #exitButton {
    position: fixed;
    bottom: calc(1.5vh + env(safe-area-inset-bottom));
    right: 50%;
    transform: translateX(50%);
    padding: 10px 20px;
    font-size: 16px;
    background: rgba(255,255,255,0.85);
    border-radius: 10px;
    border: 2px solid #000;
    color: #000;
    font-weight: bold;
    z-index: 9999;
    cursor: pointer;
  }
</style>
</head>

<body>

<div id="topBanner">Loading tile…</div>
<button id="exitButton">Exit to Map</button>
<canvas id="gameCanvas"></canvas>

<script>
// =====================================================
// SAVE SYSTEM
// =====================================================
const SAVE_KEY = "myGameSaveV1";

let save = localStorage.getItem(SAVE_KEY);
if (!save) {
  alert("No game save found. Returning to map.");
  window.location.href = "index.html";
}
save = JSON.parse(save);

// Outerworld saved structure:
const world  = save.world;
const player = save.player; // position in world grid

// We need the tile struct
const tile = world[player.y][player.x];
if (!tile) {
  alert("Tile is empty — cannot enter.");
  window.location.href = "index.html";
}

const biomeType = tile.type; // "plains", "forest", etc.

// =====================================================
// BIOME DEFINITIONS
// =====================================================
// You can expand this easily later (rarities, events, etc).
const BIOMES = {
  home: {
    label: "Home",
    background: "background_home.png",
    collision:  "collision_home.png"
  },
  plains: {
    label: "Plains",
    background: "background_plains.png",
    collision:  "collision_plains.png"
  },
  forest: {
    label: "Forest",
    background: "background_forest.png",
    collision:  "collision_forest.png"
  },
  hills: {
    label: "Hills",
    background: "background_hills.png",
    collision:  "collision_hills.png"
  }
};

// fallback
const biome = BIOMES[biomeType] || {
  label: biomeType,
  background: "background_default.png",
  collision:  "collision_default.png"
};

document.getElementById("topBanner").textContent =
  `Innerworld — ${biome.label}`;

// =====================================================
// CANVAS SETUP
// =====================================================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// =====================================================
// LOAD BACKGROUND + COLLISION MAP
// =====================================================
const bg = new Image();
bg.src = biome.background;

const collisionImg = new Image();
collisionImg.src = biome.collision;

// Offscreen canvas for collision
const colCanvas = document.createElement("canvas");
const colCtx = colCanvas.getContext("2d");

let collisionReady = false;

collisionImg.onload = () => {
  colCanvas.width = collisionImg.width;
  colCanvas.height = collisionImg.height;
  colCtx.drawImage(collisionImg, 0, 0);
  collisionReady = true;
};

// =====================================================
// CAMERA
// =====================================================
let camera = { x: 0, y: 0 };
let bgReady = false;

bg.onload = () => { bgReady = true; };

// For now — no movement. The camera just stays at 0,0.
// Later we re-enable movement controls, collision, monsters, items.

// =====================================================
// EXIT TO MAP
// =====================================================
document.getElementById("exitButton").addEventListener("click", () => {
  // If innerworld harvests items or battle results happen,
  // we would update `save` and re-save here.
  localStorage.setItem(SAVE_KEY, JSON.stringify(save));
  window.location.href = "index.html";
});

// =====================================================
// DRAW LOOP
// =====================================================
let last = 0;
function loop(t) {
  const dt = (t - last) / 1000;
  last = t;

  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// =====================================================
// DRAW
// =====================================================
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if (bgReady) {
    ctx.drawImage(
      bg,
      camera.x, camera.y,
      canvas.width, canvas.height,
      0, 0,
      canvas.width, canvas.height
    );
  }

  // Future:
  // draw items
  // draw monsters
  // draw player
  // draw effects

}
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Mobile 2D Game</title>

<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: black;
    touch-action: none;
  }

  /* wrapper uses full viewport */
  #wrapper {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #gameArea {
    position: relative;
    width: 100%;
    /* height: set dynamically in JS */
    overflow: hidden;
    background: black;
  }

  #gameCanvas {
    position: absolute;
    top: 0;
    left: 0;
  }

  #uiBar {
    width: 100%;
    /* height set dynamically in JS */
    background: rgba(30,30,30,0.9);
    color: white;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: sans-serif;
    border-top: 2px solid rgba(255,255,255,0.15);
  }

  #joystick {
    position: absolute;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    display: none;
    touch-action: none;
  }
  #stick {
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
    left: 30px;
    top: 30px;
  }
</style>
</head>

<body>
<div id="wrapper">
  <div id="gameArea">
    <canvas id="gameCanvas"></canvas>
    <div id="joystick"><div id="stick"></div></div>
  </div>
  <div id="uiBar">UI BAR</div>
</div>

<script>
// ======================================================
// LAYOUT FIX (the important part)
// ======================================================

function applyLayout() {
  const uiBar = document.getElementById("uiBar");
  const gameArea = document.getElementById("gameArea");
  const canvas = document.getElementById("gameCanvas");

  // UI bar = 10% of screen
  const uiH = Math.floor(window.innerHeight * 0.10);
  const gameH = window.innerHeight - uiH;

  uiBar.style.height = uiH + "px";
  gameArea.style.height = gameH + "px";

  // Canvas EXACTLY matches game area
  canvas.width = gameArea.clientWidth;
  canvas.height = gameArea.clientHeight;
}

// Run at startup
applyLayout();

// Fix delayed mobile viewport behavior
setTimeout(applyLayout, 100);
setTimeout(applyLayout, 500);

window.addEventListener("resize", applyLayout);

// ======================================================
// (Everything below is unchanged gameplay code)
// ======================================================

const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

const bg = new Image();
bg.src = "background.png";

const collisionImg = new Image();
collisionImg.src = "collision.png";

const frames = ["player1.png","player2.png","player3.png"].map(src=>{
  let i=new Image(); i.src=src; return i;
});

// Collision map
const colCanvas=document.createElement("canvas");
const colCtx=colCanvas.getContext("2d");
let collisionReady=false;

collisionImg.onload=()=>{
  colCanvas.width=collisionImg.width;
  colCanvas.height=collisionImg.height;
  colCtx.drawImage(collisionImg,0,0);
  collisionReady=true;
};

function isBlocked(x,y){
  if(!collisionReady) return false;
  if(x<0||y<0||x>=colCanvas.width||y>=colCanvas.height) return true;
  const d=colCtx.getImageData(x,y,1,1).data;
  return d[0]<50&&d[1]<50&&d[2]<50;
}

// Player
let player={
  x:500,
  y:500,
  speed:180,
  frame:0,
  frameTimer:0,
  scale:0.25,
  moving:false,
  facingLeft:false
};

// Camera
let camera={x:0,y:0};

function updateCamera(){
  const w=canvas.width, h=canvas.height;
  let tx=player.x-w/2;
  let ty=player.y-h/2;

  tx=Math.max(0,Math.min(tx,bg.width-w));
  ty=Math.max(0,Math.min(ty,bg.height-h));

  camera.x+=(tx-camera.x)*0.1;
  camera.y+=(ty-camera.y)*0.1;
}

// Joystick
const joyDiv=document.getElementById("joystick");
const stick=document.getElementById("stick");

let joy={active:false,dx:0,dy:0,originX:0,originY:0};

canvas.addEventListener("touchstart",e=>{
  const t=e.touches[0];
  joy.active=true;
  joy.originX=t.clientX;
  joy.originY=t.clientY;
  joyDiv.style.left=(t.clientX-60)+"px";
  joyDiv.style.top=(t.clientY-60)+"px";
  joyDiv.style.display="block";
  stick.style.left="30px";
  stick.style.top="30px";
});

canvas.addEventListener("touchmove",e=>{
  if(!joy.active) return;
  const t=e.touches[0];
  let dx=t.clientX-joy.originX;
  let dy=t.clientY-joy.originY;
  const dist=Math.hypot(dx,dy);
  const max=40;
  if(dist>max){ dx=(dx/dist)*max; dy=(dy/dist)*max }

  stick.style.left=(30+dx)+"px";
  stick.style.top=(30+dy)+"px";

  joy.dx=dx/max;
  joy.dy=dy/max;
});

canvas.addEventListener("touchend",()=>{
  joy.active=false;
  joy.dx=joy.dy=0;
  joyDiv.style.display="none";
});

// MAIN LOOP
let last=0;
function loop(t){
  const dt=(t-last)/1000;
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// UPDATE
function update(dt){
  player.moving=Math.abs(joy.dx)>0.05||Math.abs(joy.dy)>0.05;

  if(player.moving){
    let nx=player.x+joy.dx*player.speed*dt;
    let ny=player.y+joy.dy*player.speed*dt;

    if(!isBlocked(nx,player.y)) player.x=nx;
    if(!isBlocked(player.x,ny)) player.y=ny;
  }

  if(joy.dx<-0.05) player.facingLeft=true;
  else if(joy.dx>0.05) player.facingLeft=false;

  if(player.moving){
    player.frameTimer+=dt;
    if(player.frameTimer>0.15){
      player.frame=(player.frame+1)%3;
      player.frameTimer=0;
    }
  } else player.frame=0;

  updateCamera();
}

// DRAW
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(bg.width>0){
    ctx.drawImage(bg,
      camera.x,camera.y,
      canvas.width,canvas.height,
      0,0,canvas.width,canvas.height);
  }

  const img=frames[player.frame];
  const w=img.width*player.scale;
  const h=img.height*player.scale;
  const dx=player.x-camera.x-w/2;
  const dy=player.y-camera.y-h/2;

  if(player.facingLeft){
    ctx.save();
    ctx.translate(dx+w/2,dy+h/2);
    ctx.scale(-1,1);
    ctx.drawImage(img,-w/2,-h/2,w,h);
    ctx.restore();
  } else {
    ctx.drawImage(img,dx,dy,w,h);
  }
}
</script>

</body>
</html>

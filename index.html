<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Mobile 2D Test</title>
<style>
  html, body {
    margin: 0; padding: 0;
    overflow: hidden;
    background: black;
    touch-action: none;
  }

  #gameCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
  }

  /* JOYSTICK (hidden by default) */
  #joystick {
    position: absolute;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    display: none;
    touch-action: none;
  }

  #stick {
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
    left: 30px;
    top: 30px;
    touch-action: none;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="joystick">
  <div id="stick"></div>
</div>

<script>
// =============== CANVAS ===============
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

// =============== ASSETS ===============
const bg = new Image();
bg.src = "background.png"; // ★ your map image

const frames = ["player1.png", "player2.png", "player3.png"].map(src => {
  const img = new Image();
  img.src = src;
  return img;
});

// =============== PLAYER ===============
let player = {
  x: 1500,      // start somewhere not (0,0)
  y: 1500,
  speed: 200,
  frame: 0,
  frameTimer: 0,
  scale: 0.28  // ★ smaller player now
};

// =============== CAMERA ===============
let camera = { x: 0, y: 0 };

// Keeps camera centered but clamped to the background edges
function updateCamera() {
  camera.x = player.x - canvas.width / 2;
  camera.y = player.y - canvas.height / 2;

  // Clamp camera to world boundaries
  camera.x = Math.max(0, Math.min(camera.x, bg.width - canvas.width));
  camera.y = Math.max(0, Math.min(camera.y, bg.height - canvas.height));
}

// =============== JOYSTICK ===============
const joyDiv = document.getElementById("joystick");
const stick = document.getElementById("stick");

let joy = {
  active: false,
  dx: 0,
  dy: 0,
  originX: 0,
  originY: 0
};

// =============== TOUCH LOGIC ===============
canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];

  joy.active = true;
  joy.originX = t.clientX;
  joy.originY = t.clientY;

  joyDiv.style.left = (t.clientX - 60) + "px";
  joyDiv.style.top = (t.clientY - 60) + "px";
  joyDiv.style.display = "block";

  stick.style.left = "30px";
  stick.style.top = "30px";
});

canvas.addEventListener("touchmove", e => {
  if (!joy.active) return;

  const t = e.touches[0];
  const dx = t.clientX - joy.originX;
  const dy = t.clientY - joy.originY;

  const dist = Math.hypot(dx, dy);
  const max = 40;

  let ndx = dx;
  let ndy = dy;

  if (dist > max) {
    ndx = (dx / dist) * max;
    ndy = (dy / dist) * max;
  }

  stick.style.left = (30 + ndx) + "px";
  stick.style.top = (30 + ndy) + "px";

  joy.dx = ndx / max;
  joy.dy = ndy / max;
});

canvas.addEventListener("touchend", () => {
  joy.active = false;
  joy.dx = joy.dy = 0;
  joyDiv.style.display = "none";
});

// =============== MAIN LOOP ===============
let last = 0;
function loop(t) {
  const dt = (t - last) / 1000;
  last = t;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

function update(dt) {
  // Move player
  player.x += joy.dx * player.speed * dt;
  player.y += joy.dy * player.speed * dt;

  // Keep inside world boundaries
  if (bg.width > 0) {
    player.x = Math.max(0, Math.min(player.x, bg.width));
    player.y = Math.max(0, Math.min(player.y, bg.height));
  }

  // Animate sprite
  player.frameTimer += dt;
  if (player.frameTimer > 0.2) {
    player.frame = (player.frame + 1) % frames.length;
    player.frameTimer = 0;
  }

  updateCamera();
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Draw WORLD BACKGROUND (offset by camera)
  if (bg.width > 0) {
    ctx.drawImage(
      bg,
      camera.x, camera.y,                   // source top-left
      canvas.width, canvas.height,          // source size
      0, 0,                                 // destination top-left
      canvas.width, canvas.height           // destination size
    );
  }

  // Draw PLAYER (at center of screen)
  const img = frames[player.frame];
  if (img.width > 0) {
    const w = img.width * player.scale;
    const h = img.height * player.scale;
    ctx.drawImage(
      img,
      canvas.width/2 - w/2,
      canvas.height/2 - h/2,
      w, h
    );
  }
}
</script>

</body>
</html>

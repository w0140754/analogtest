<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Mobile Game</title>

<style>
  html, body {
    margin: 0; padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    background: black;
    touch-action: none;
  }

  /* FULLSCREEN CANVAS — DOES NOT SHRINK */
  #gameCanvas {
    position: absolute;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
  }

  /* JOYSTICK OVERLAY */
  #joystick {
    position: absolute;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    display: none;
    touch-action: none;
    z-index: 10;
  }
  #stick {
    position: absolute;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255,255,255,0.4);
    left: 30px;
    top: 30px;
    touch-action: none;
  }

  /* UI BAR OVERLAY (BOTTOM 10%) */
  #uiBar {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100vw;
    height: 10vh;                     /* bottom 10% */
    background: rgba(30,30,30,0.6);    /* semi-transparent */
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: sans-serif;
    z-index: 20;                       /* above gameplay */
    backdrop-filter: blur(4px);
    border-top: 2px solid rgba(255,255,255,0.2);
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>

<div id="joystick">
  <div id="stick"></div>
</div>

<div id="uiBar">
  UI BAR
</div>

<script>
// =====================================================
// CANVAS SETUP — fullscreen, collision-safe
// =====================================================
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

// =====================================================
// ASSETS
// =====================================================
const bg = new Image();
bg.src = "background.png";   // 768×768

// player frames
const frames = ["player1.png","player2.png","player3.png"].map(src=>{
  let i = new Image();
  i.src = src;
  return i;
});

// collision map
const colImg = new Image();
colImg.src = "collision.png";

const colCanvas = document.createElement("canvas");
const colCtx = colCanvas.getContext("2d");
let collisionReady = false;

colImg.onload = () => {
  colCanvas.width = colImg.width;
  colCanvas.height = colImg.height;
  colCtx.drawImage(colImg, 0, 0);
  collisionReady = true;
};

function isBlocked(px, py) {
  if (!collisionReady) return false;

  if (px < 0 || py < 0 || px >= colCanvas.width || py >= colCanvas.height)
    return true;

  const d = colCtx.getImageData(px, py, 1, 1).data;
  return d[0] < 50 && d[1] < 50 && d[2] < 50;
}

// =====================================================
// PLAYER
// =====================================================
let player = {
  x: 500,
  y: 500,
  speed: 180,
  frame: 0,
  frameTimer: 0,
  scale: 0.25,
  moving: false,
  facingLeft: false
};

// =====================================================
// CAMERA
// =====================================================
let camera = { x: 0, y: 0 };

function updateCamera() {
  let tx = player.x - canvas.width / 2;
  let ty = player.y - canvas.height / 2;

  tx = Math.max(0, Math.min(tx, bg.width - canvas.width));
  ty = Math.max(0, Math.min(ty, bg.height - canvas.height));

  camera.x += (tx - camera.x) * 0.1;
  camera.y += (ty - camera.y) * 0.1;
}

// =====================================================
// JOYSTICK
// =====================================================
const joyDiv = document.getElementById("joystick");
const stick = document.getElementById("stick");

let joy = {
  active: false,
  dx: 0, dy: 0,
  originX: 0,
  originY: 0
};

canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];
  joy.active = true;
  joy.originX = t.clientX;
  joy.originY = t.clientY;

  joyDiv.style.left = (t.clientX - 60) + "px";
  joyDiv.style.top = (t.clientY - 60) + "px";
  joyDiv.style.display = "block";
  stick.style.left = "30px";
  stick.style.top = "30px";
});

canvas.addEventListener("touchmove", e => {
  if (!joy.active) return;
  const t = e.touches[0];
  let dx = t.clientX - joy.originX;
  let dy = t.clientY - joy.originY;

  const dist = Math.hypot(dx, dy);
  const max = 40;

  if (dist > max) {
    dx = dx / dist * max;
    dy = dy / dist * max;
  }

  stick.style.left = (30 + dx) + "px";
  stick.style.top = (30 + dy) + "px";

  joy.dx = dx / max;
  joy.dy = dy / max;
});

canvas.addEventListener("touchend", () => {
  joy.active = false;
  joy.dx = joy.dy = 0;
  joyDiv.style.display = "none";
});

// =====================================================
// GAME LOOP
// =====================================================
let last = 0;

function loop(t) {
  const dt = (t - last) / 1000;
  last = t;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// =====================================================
// UPDATE
// =====================================================
function update(dt) {
  player.moving = Math.abs(joy.dx) > 0.05 || Math.abs(joy.dy) > 0.05;

  if (player.moving) {
    let nx = player.x + joy.dx * player.speed * dt;
    let ny = player.y + joy.dy * player.speed * dt;

    if (!isBlocked(nx, player.y)) player.x = nx;
    if (!isBlocked(player.x, ny)) player.y = ny;
  }

  // face direction
  if (joy.dx < -0.05) player.facingLeft = true;
  else if (joy.dx > 0.05) player.facingLeft = false;

  // animate
  if (player.moving) {
    player.frameTimer += dt;
    if (player.frameTimer > 0.15) {
      player.frame = (player.frame + 1) % 3;
      player.frameTimer = 0;
    }
  } else {
    player.frame = 0;
  }

  updateCamera();
}

// =====================================================
// DRAW
// =====================================================
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.imageSmoothingEnabled = false;

  if (bg.width > 0) {
    ctx.drawImage(
      bg,
      Math.floor(camera.x), Math.floor(camera.y),
      canvas.width, canvas.height,
      0, 0,
      canvas.width, canvas.height
    );
  }

  const img = frames[player.frame];
  const w = img.width * player.scale;
  const h = img.height * player.scale;

  const dx = player.x - camera.x - w/2;
  const dy = player.y - camera.y - h/2;

  if (player.facingLeft) {
    ctx.save();
    ctx.translate(dx + w/2, dy + h/2);
    ctx.scale(-1, 1);
    ctx.drawImage(img, -w/2, -h/2, w, h);
    ctx.restore();
  } else {
    ctx.drawImage(img, dx, dy, w, h);
  }
}
</script>

</body>
</html>

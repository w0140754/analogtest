<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>Outerworld ‚Äî Persistent 5x5 Grid</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #05070b;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: #f9fafb;
    overflow: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
  }

  /* ======================================
     TOP TOOLBAR (CENTERED EXPLORE)
     ====================================== */
  #banner {
    flex: 0 0 auto;
    padding: 10px 14px;
    background: linear-gradient(to right, #111827, #020617);
    border-bottom: 1px solid rgba(148,163,184,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  #banner-left {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
  }

  #banner-sub {
    font-size: 13px;
    color: #cbd5e1;
  }

  #enterButtonTop {
    padding: 6px 18px;
    font-size: 13px;
    border-radius: 999px;
    border: 1px solid rgba(249,250,251,0.9);
    background: linear-gradient(to right, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    cursor: pointer;
    display: none;
    text-transform: uppercase;
  }

  /* ======================================
     RARITY COLORS
     ====================================== */
  .rarity-common { color: #b87333; }
  .rarity-uncommon { color: #c0c0c0; }
  .rarity-rare { color: #e8a317; }

  /* ======================================
     MESSAGE BANNER
     ====================================== */
  #messageBanner {
    flex: 0 0 auto;
    width: 100%;
    text-align: center;
    padding: 6px 0;
    font-size: 14px;
    background: rgba(15,23,42,0.75);
    border-bottom: 1px solid rgba(148,163,184,0.25);
    display: none;
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  /* ======================================
     GRID (TOP-ANCHORED)
     ====================================== */
  #gridWrapper {
    flex: 0 0 auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding-top: 10px;
  }

  #gridSquare {
    width: min(98vw, 98vh);
    max-width: 720px;
    aspect-ratio: 1 / 1;
    background: radial-gradient(circle at top, #1e293b, #020617);
    border-radius: 16px;
    padding: 4px;
    box-sizing: border-box;
    display: flex;
  }

  #grid {
    position: relative;
    flex: 1;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 2px;
  }

  .tile {
    border-radius: 8px;
    overflow: hidden;
    background-color: #020617;
    background-size: cover;
    background-position: center;
    cursor: pointer;
  }

  .tile-highlight-playable {
    box-shadow:
      0 0 0 2px rgba(250,204,21,0.9),
      0 0 18px rgba(250,204,21,0.7);
  }

  /* PLAYER SPRITE */
  .player-sprite {
    position: absolute;
    background-image: url("overworld_player_idle.png");
    background-size: contain;
    background-repeat: no-repeat;
    pointer-events: none;
    transition: transform 0.2s ease-out;
  }

  /* ======================================
     FLOATING CARD BUTTON
     ====================================== */
  #cardToggleButton {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.8);
    background: radial-gradient(circle at top, #1e293b, #020617);
    color: #e5e7eb;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 5000;
  }

  /* ======================================
     CARD DRAWER ‚Äî FULL HEIGHT BELOW GRID
     ====================================== */
  #cardOverlay {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;

    height: auto;
    max-height: none;

    background: #020617;
    border-top: 1px solid rgba(148,163,184,0.7);

    display: none;
    flex-direction: column;
    padding: 12px;
    overflow-x: auto;
    overflow-y: hidden;
    z-index: 3000;

    white-space: nowrap;
  }

  #cardOverlayHeader {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
  }

  #cardOverlayTitle {
    font-size: 13px;
    color: #9ca3af;
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  /* ======================================
     PORTRAIT CARDS ‚Äî DYNAMIC SIZE
     ====================================== */
  .card {
    display: inline-block;
    background: radial-gradient(circle at top, #0f172a, #020617);
    border: 1px solid rgba(148,163,184,0.6);
    border-radius: 10px;

    /* Height fills drawer; width auto (portrait) */
    height: calc(100% - 60px);  /* minus header + padding */
    aspect-ratio: 0.7 / 1;      /* portrait shape */

    overflow: hidden;
    position: relative;
    margin-right: 10px;
    vertical-align: top;
    cursor: pointer;
  }

  .card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-selected {
    border-color: rgba(250,204,21,1);
    transform: translateY(-3px) scale(1.05);
  }

  .card-disabled {
    opacity: 0.35;
    pointer-events: none;
  }

  .card-count {
    position: absolute;
    bottom: 4px;
    right: 4px;
    background: rgba(15,23,42,0.9);
    padding: 2px 5px;
    border-radius: 8px;
    font-size: 10px;
  }
</style>
</head>
<body>

<div id="outerRoot">

  <!-- TOOLBAR -->
  <div id="banner">
    <div id="banner-left">
      <div id="banner-sub">
        <span id="banner-tileName">Home</span>
      </div>
    </div>

    <button id="enterButtonTop">Explore</button>
  </div>

  <!-- MESSAGE BANNER -->
  <div id="messageBanner"></div>

  <!-- GRID -->
  <div id="gridWrapper">
    <div id="gridSquare">
      <div id="grid"></div>
    </div>
  </div>

</div>

<!-- FLOATING CARD BUTTON -->
<button id="cardToggleButton">üÉè</button>

<!-- CARD DRAWER -->
<div id="cardOverlay">
  <div id="cardOverlayHeader">
    <span id="cardOverlayTitle">Cards</span>
    <button id="cardOverlayClose">‚úï</button>
  </div>

  <div id="cardOverlayCards"></div>
</div>

<script>
/* ======================================================================
   SCRIPT -- ALL NEW CARD DRAWER LOGIC INCLUDED
====================================================================== */

const SIZE = 5;
const SAVE_KEY = "myGameSaveV1";

const TILE_TYPES = {
  home:   { label:"Home",   image:"tile_home.png" },
  plains: { label:"Plains", image:"tile_plains.png" },
  hills:  { label:"Hills",  image:"tile_hills.png" },
  forest: { label:"Forest", image:"tile_forest.png" }
};

const DEFAULT_CARDS = [
  { type:"plains", label:"Plains", image:"card_plains.png", count:3 },
  { type:"hills",  label:"Hills",  image:"card_hills.png",  count:2 },
  { type:"forest", label:"Forest", image:"card_forest.png", count:2 }
];

let world, cards, playerX, playerY;
let selectedCardType=null;
let pendingTile=null;
let cardMenuOpen=false;
let playerFacing=1;

const gridEl=document.getElementById("grid");
const bannerTileNameEl=document.getElementById("banner-tileName");
const enterButtonEl=document.getElementById("enterButtonTop");
const messageBannerEl=document.getElementById("messageBanner");
const cardOverlayEl=document.getElementById("cardOverlay");
const cardOverlayCardsEl=document.getElementById("cardOverlayCards");

let playerSpriteEl=document.createElement("div");
playerSpriteEl.className="player-sprite";

/* ===========================================
   SAVE / LOAD
=========================================== */
function createFreshState(){
  world=Array.from({length:SIZE},()=>Array(SIZE).fill(null));
  playerX=2; playerY=2;
  world[playerY][playerX]={ type:"home" };
  cards=DEFAULT_CARDS.map(c=>({...c}));
}

function loadGame(){
  const raw=localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try {
    const data=JSON.parse(raw);
    world=data.world;
    playerX=data.player.x;
    playerY=data.player.y;
    cards=data.cards;
    return true;
  } catch { return false; }
}

function saveGame(){
  localStorage.setItem(SAVE_KEY, JSON.stringify({
    world,
    player:{x:playerX,y:playerY},
    cards
  }));
}

/* ===========================================
   BANNER
=========================================== */
function updateBanner(){
  const tile=getTile(playerX,playerY);

  if (!tile){
    bannerTileNameEl.textContent="Empty";
    return;
  }

  if (tile.type==="home"){
    bannerTileNameEl.textContent="Home";
    return;
  }

  const rarity=tile.rarity || "common";
  const biome=TILE_TYPES[tile.type].label;
  const rCap=rarity.charAt(0).toUpperCase()+rarity.slice(1);

  bannerTileNameEl.innerHTML =
    `<span class="rarity-${rarity}">${rCap}</span> ${biome}`;
}

/* ===========================================
   MESSAGE BANNER
=========================================== */
function showMessageBanner(rarity, biome){
  if (biome==="Home"){
    messageBannerEl.innerHTML="Discovered Home!";
  } else {
    const rCap=rarity.charAt(0).toUpperCase()+rarity.slice(1);
    messageBannerEl.innerHTML =
      `Discovered <span class="rarity-${rarity}">${rCap}</span> ${biome}!`;
  }

  messageBannerEl.style.display="block";
  requestAnimationFrame(()=>messageBannerEl.style.opacity="1");

  setTimeout(()=>{
    messageBannerEl.style.opacity="0";
    setTimeout(()=>messageBannerEl.style.display="none",300);
  },1800);
}

/* ===========================================
   EXPLORE BUTTON
=========================================== */
function updateEnterButton(){
  const tile=getTile(playerX,playerY);
  if (!tile) return enterButtonEl.style.display="none";

  enterButtonEl.textContent="Explore";
  enterButtonEl.style.display="inline-block";
}

enterButtonEl.onclick=()=>{
  const tile=getTile(playerX,playerY);
  if (!tile) return;

  const rarity=tile.type==="home" ? "common" : tile.rarity || "common";

  localStorage.setItem("innerworld_entry", JSON.stringify({
    tile:{ type:tile.type, rarity },
    playerStart:{ x:250, y:250 }
  }));

  saveGame();
  window.location.href="innerworld.html";
};

/* ===========================================
   GRID
=========================================== */
function initGridDOM(){
  gridEl.innerHTML="";
  for (let y=0; y<SIZE; y++){
    for (let x=0; x<SIZE; x++){
      const d=document.createElement("div");
      d.className="tile";
      d.dataset.x=x;
      d.dataset.y=y;
      d.onclick=onTileClick;
      gridEl.appendChild(d);
    }
  }
  gridEl.appendChild(playerSpriteEl);
}

function renderGrid(){
  for (const d of gridEl.children){
    if (!d.dataset.x) continue;

    const x=parseInt(d.dataset.x);
    const y=parseInt(d.dataset.y);
    const tile=getTile(x,y);

    d.style.backgroundImage = tile ? `url('${TILE_TYPES[tile.type].image}')` : "";

    d.classList.toggle("tile-highlight-playable",
      !tile && canPlay() && isAdjacent(x,y)
    );
  }
  positionPlayerSprite();
}

function positionPlayerSprite(){
  const tileEl = [...gridEl.children]
    .find(el => el.dataset.x==playerX && el.dataset.y==playerY);
  if (!tileEl) return;

  const tr=tileEl.getBoundingClientRect();
  const gr=gridEl.getBoundingClientRect();

  const x=tr.left-gr.left;
  const y=tr.top -gr.top;

  playerSpriteEl.style.width=tr.width+"px";
  playerSpriteEl.style.height=tr.height+"px";

  playerSpriteEl.style.transform =
    `translate(${x}px,${y}px) scaleX(${playerFacing===-1?-1:1})`;
}

window.addEventListener("resize", positionPlayerSprite);

/* ===========================================
   TILE CLICK
=========================================== */
function onTileClick(e){
  const x=parseInt(e.target.dataset.x);
  const y=parseInt(e.target.dataset.y);
  const tile=getTile(x,y);

  if (!tile && isAdjacent(x,y) && canPlay()){
    pendingTile={x,y};
    selectedCardType=null;
    openCardDrawer(true);
    return;
  }

  if (tile && isAdjacent(x,y)){
    if (x<playerX) playerFacing=-1;
    if (x>playerX) playerFacing=1;

    playerX=x; playerY=y;

    pendingTile=null;
    selectedCardType=null;
    closeCardDrawer();

    renderGrid();
    updateBanner();
    updateEnterButton();
    saveGame();
    return;
  }

  if (cardMenuOpen) closeCardDrawer();
}

function isAdjacent(x,y){
  return Math.abs(x-playerX)+Math.abs(y-playerY)===1;
}

function canPlay(){
  return cards.some(c=>c.count>0);
}

/* ===========================================
   CARD DRAWER
=========================================== */
document.getElementById("cardToggleButton").onclick = ()=>{
  if (cardMenuOpen) closeCardDrawer();
  else openCardDrawer(false);
};

document.getElementById("cardOverlayClose").onclick = closeCardDrawer;

function openCardDrawer(isTile){
  cardMenuOpen=true;
  cardOverlayEl.style.display="flex";

  if (isTile && pendingTile){
    const {x,y} = pendingTile;
    cardOverlayTitleEl.textContent = `Select card for (${x+1},${y+1})`;
  } else {
    cardOverlayTitleEl.textContent = "Cards";
  }

  renderCardDrawer();
  adjustDrawerHeight();
}

function closeCardDrawer(){
  cardMenuOpen=false;
  cardOverlayEl.style.display="none";
  selectedCardType=null;
  pendingTile=null;
}

function adjustDrawerHeight(){
  const bannerH=document.getElementById("banner").offsetHeight;
  const msgH=messageBannerEl.offsetHeight || 0;
  const gridH=document.getElementById("gridWrapper").offsetHeight;

  const used= bannerH + msgH + gridH + 8;
  const total= window.innerHeight;

  const drawerH = Math.max(100, total - used);

  cardOverlayEl.style.height = drawerH + "px";

  // Force cards to resize (portrait)
  for (const card of cardOverlayCardsEl.children){
    card.style.height = (drawerH - 50) + "px"; // 50px padding for header
    card.style.width  = ((drawerH - 50) * 0.7) + "px";
  }
}

window.addEventListener("resize", adjustDrawerHeight);

function renderCardDrawer(){
  cardOverlayCardsEl.innerHTML="";
  for (const card of cards){
    const div=document.createElement("div");
    div.className="card";
    div.dataset.type=card.type;

    const img=document.createElement("img");
    img.src=card.image;

    const count=document.createElement("div");
    count.className="card-count";
    count.textContent="x" + card.count;

    div.appendChild(img);
    div.appendChild(count);
    div.onclick = onCardClick;

    if (card.count===0) div.classList.add("card-disabled");

    cardOverlayCardsEl.appendChild(div);
  }

  adjustDrawerHeight();
}

function onCardClick(e){
  const type=e.currentTarget.dataset.type;
  const card=getCard(type);
  if (!card || card.count<=0) return;

  if (pendingTile && selectedCardType===type){
    placeCard(type);
    return;
  }

  selectedCardType=type;

  for (const c of cardOverlayCardsEl.children){
    c.classList.toggle("card-selected", c.dataset.type===type);
  }
}

function placeCard(type){
  const {x,y} = pendingTile;
  const card=getCard(type);

  if (!card || card.count<=0) return;

  const rarity="common";

  world[y][x] = { type, rarity };

  card.count--;

  const biome=TILE_TYPES[type].label;
  showMessageBanner(rarity, biome);

  pendingTile=null;

  saveGame();
  renderGrid();
  updateBanner();
  updateEnterButton();
  closeCardDrawer();
}

/* ===========================================
   GETTERS
=========================================== */
function getTile(x,y){
  return world[y][x];
}
function getCard(type){
  return cards.find(c=>c.type===type);
}
function isBound(x,y){
  return x>=0&&x<SIZE&&y>=0&&y<SIZE;
}

/* ===========================================
   INIT
=========================================== */
function initUI(){
  initGridDOM();
  renderGrid();
  updateBanner();
  updateEnterButton();
}

(function start(){
  const hasSave=loadGame();
  if (!hasSave){
    createFreshState();
    saveGame();
  }
  initUI();
})();
</script>

</body>
</html>

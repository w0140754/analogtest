<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,viewport-fit=cover,user-scalable=no" />
<title>Outerworld ‚Äî Persistent 5x5 Grid</title>

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: #05070b;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: #f9fafb;
    overflow: hidden;
  }

  body {
    display: flex;
    flex-direction: column;
  }

  /* =========================
     NEW GAME SCREEN
  ========================== */
  #newGameScreen {
    position: fixed;
    inset: 0;
    background: #020617;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
    z-index: 20000;
  }

  #newGameTitle {
    font-size: 18px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #e5e7eb;
  }

  #newGameButton {
    padding: 10px 22px;
    font-size: 16px;
    border-radius: 999px;
    border: 1px solid rgba(249,250,251,0.9);
    background: linear-gradient(to right, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 18px rgba(34,197,94,0.6);
  }

  /* =========================
     MAIN LAYOUT
  ========================== */
  #outerRoot {
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  /* =========================
     TOP TOOLBAR
  ========================== */
  #banner {
    flex: 0 0 auto;
    padding: 10px 14px;
    background: linear-gradient(to right, #111827, #020617);
    border-bottom: 1px solid rgba(148,163,184,0.3);
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }

  #banner-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  #banner-sub {
    font-size: 13px;
    color: #cbd5e1;
  }

  /* =========================
     MESSAGE BANNER
  ========================== */
  #messageBanner {
    flex: 0 0 auto;
    width: 100%;
    text-align: center;
    padding: 6px 0;
    font-size: 14px;
    letter-spacing: 0.03em;
    background: rgba(15,23,42,0.75);
    border-bottom: 1px solid rgba(148,163,184,0.25);
    display: none;
    opacity: 0;
    transition: opacity 0.35s ease;
  }

  .rarity-common { color: #b87333; }
  .rarity-uncommon { color: #c0c0c0; }
  .rarity-rare { color: #e8a317; }

  /* =========================
     EXPLORE BUTTON
  ========================== */
  #enterButtonTop {
    padding: 6px 18px;
    font-size: 13px;
    border-radius: 999px;
    border: 1px solid rgba(249,250,251,0.9);
    background: linear-gradient(to right, #22c55e, #4ade80);
    color: #022c22;
    font-weight: 600;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    cursor: pointer;
    display: none;
  }

  /* =========================
     GRID ‚Äì NOW ANCHORED TO TOP
  ========================== */
  #gridWrapper {
    flex: 1 1 auto;
    display: flex;
    justify-content: center;
    align-items: flex-start; /* <‚Äî moved from center to top */
    padding-top: 10px;
  }

  #gridSquare {
    position: relative;
    width: min(98vw, 98vh);
    max-width: 720px;
    aspect-ratio: 1 / 1;
    background: radial-gradient(circle at top, #1e293b, #020617);
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(15,23,42,0.9);
    padding: 4px;
    box-sizing: border-box;
    display: flex;
  }

  #grid {
    position: relative;
    flex: 1;
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-template-rows: repeat(5, 1fr);
    gap: 2px;
  }

  .tile {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background-color: #020617;
    background-size: cover;
    background-position: center;
    cursor: pointer;
    box-shadow: inset 0 0 0 1px rgba(15,23,42,0.9);
  }

  .tile-highlight-playable {
    box-shadow:
      0 0 0 2px rgba(250,204,21,0.9),
      0 0 18px rgba(250,204,21,0.7);
  }

  /* PLAYER SPRITE */
  .player-sprite {
    position: absolute;
    background-image: url("overworld_player_idle.png");
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    transform-origin: center center;
    transition: transform 0.2s ease-out;
    pointer-events: none;
  }

  /* =========================
     CARD FLOATING BUTTON
  ========================== */
  #cardToggleButton {
    position: fixed;
    top: 10px;
    right: 10px;
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.8);
    background: radial-gradient(circle at top, #1e293b, #020617);
    color: #e5e7eb;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 4000;
  }

  /* =========================
     CARD OVERLAY (DRAWER)
  ========================== */
  #cardOverlay {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    max-height: 70vh; /* <‚Äî MORE SPACE NOW */
    background: radial-gradient(circle at top, #020617, #020617);
    border-top: 1px solid rgba(148,163,184,0.7);
    box-shadow: 0 -12px 30px rgba(15,23,42,0.9);
    display: none;
    flex-direction: column;
    padding: 8px 10px 10px;
    gap: 8px;
    z-index: 3000;
  }

  #cardOverlayHeader {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  #cardOverlayTitle {
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #9ca3af;
  }

  #cardOverlayCards {
    display: flex;
    gap: 10px;
    overflow-x: auto;
  }

  .card {
    position: relative;
    flex: 0 0 auto;
    width: 64px;
    height: 90px;
    border-radius: 10px;
    background: radial-gradient(circle at top, #0f172a, #020617);
    border: 1px solid rgba(148,163,184,0.7);
    box-shadow: 0 8px 16px rgba(15,23,42,0.9);
    cursor: pointer;
  }

  .card-disabled { opacity: 0.35; }
  .card-selected {
    transform: translateY(-4px) scale(1.06);
    border-color: rgba(250,204,21,1);
  }

  .card-count {
    position: absolute;
    right: 4px;
    bottom: 4px;
    padding: 2px 5px;
    border-radius: 999px;
    background: rgba(15,23,42,0.9);
    font-size: 10px;
  }
</style>
</head>
<body>

<!-- NEW GAME SCREEN -->
<div id="newGameScreen">
  <div id="newGameTitle">New World</div>
  <button id="newGameButton">Start New Game</button>
</div>

<div id="outerRoot">

  <!-- TOP TOOLBAR -->
  <div id="banner">
    <div id="banner-left">
      <div id="banner-sub">
        <span id="banner-tileName">Home</span>
      </div>
    </div>

    <button id="enterButtonTop">Explore</button>
  </div>

  <!-- MESSAGE BANNER -->
  <div id="messageBanner"></div>

  <!-- GRID -->
  <div id="gridWrapper">
    <div id="gridSquare">
      <div id="grid"></div>
    </div>
  </div>
</div>

<button id="cardToggleButton">üÉè</button>

<!-- CARD OVERLAY -->
<div id="cardOverlay">
  <div id="cardOverlayHeader">
    <div id="cardOverlayTitle">Cards</div>
    <button id="cardOverlayClose">‚úï</button>
  </div>
  <div id="cardOverlayCards"></div>
</div>

<script>
/* ======================================================================
   ALL SCRIPT CODE BELOW ‚Äî SAME AS BEFORE EXCEPT FOR:
   - updated banner formatting
   - removed coordinates
   - Explore button always says ‚ÄúExplore‚Äù
   ====================================================================== */

const SAVE_KEY = "myGameSaveV1";
const SIZE = 5;

const TILE_TYPES = {
  home:   { label: "Home",   image: "tile_home.png" },
  plains: { label: "Plains", image: "tile_plains.png" },
  hills:  { label: "Hills",  image: "tile_hills.png" },
  forest: { label: "Forest", image: "tile_forest.png" }
};

const DEFAULT_CARDS = [
  { type: "plains", label: "Plains", image: "card_plains.png", count: 3 },
  { type: "hills",  label: "Hills",  image: "card_hills.png",  count: 2 },
  { type: "forest", label: "Forest", image: "card_forest.png", count: 2 }
];

let world, playerX, playerY, cards;
let selectedCardType = null;
let pendingTile = null;
let cardMenuOpen = false;
let playerFacing = 1;

/* =======================
   SAVE / LOAD
======================= */
function createFreshState() {
  world = Array.from({ length: SIZE }, () => Array(SIZE).fill(null));
  playerX = 2;
  playerY = 2;
  world[playerY][playerX] = { type: "home" };
  cards = DEFAULT_CARDS.map(c => ({ ...c }));
}

function loadGame() {
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try {
    const data = JSON.parse(raw);
    if (!data.world || !data.player) return false;

    world = data.world;
    playerX = data.player.x;
    playerY = data.player.y;
    cards = Array.isArray(data.cards)
      ? data.cards
      : DEFAULT_CARDS.map(c => ({ ...c }));

    return true;
  } catch {
    return false;
  }
}

function saveGame() {
  localStorage.setItem(
    SAVE_KEY,
    JSON.stringify({ world, player: { x: playerX, y: playerY }, cards })
  );
}

/* =======================
   DOM REFERENCES
======================= */
const newGameScreen = document.getElementById("newGameScreen");
const newGameButton = document.getElementById("newGameButton");
const outerRoot     = document.getElementById("outerRoot");

const gridEl = document.getElementById("grid");
const bannerTileNameEl = document.getElementById("banner-tileName");
const enterButtonEl = document.getElementById("enterButtonTop");

const cardToggleButtonEl = document.getElementById("cardToggleButton");
const cardOverlayEl = document.getElementById("cardOverlay");
const cardOverlayCardsEl = document.getElementById("cardOverlayCards");
const cardOverlayTitleEl = document.getElementById("cardOverlayTitle");
const cardOverlayCloseEl = document.getElementById("cardOverlayClose");

const messageBannerEl = document.getElementById("messageBanner");

let tileElements = [];
let playerSpriteEl = document.createElement("div");
playerSpriteEl.className = "player-sprite";

/* =======================
   HELPERS
======================= */
function inBounds(x,y){ return x>=0 && x<SIZE && y>=0 && y<SIZE; }
function getTile(x,y){ return inBounds(x,y) ? world[y][x] : null; }
function isAdjacent(x,y){
  return Math.abs(x-playerX) + Math.abs(y-playerY) === 1;
}
function getCard(type){ return cards.find(c => c.type===type); }
function canPlayAnyCard(){ return cards.some(c => c.count>0); }

/* =======================
   BANNER UPDATE
======================= */
function updateBanner() {
  const tile = getTile(playerX, playerY);

  if (!tile) {
    bannerTileNameEl.textContent = "Empty";
    return;
  }

  if (tile.type === "home") {
    bannerTileNameEl.textContent = "Home";
    return;
  }

  const rarity = tile.rarity || "common";
  const rarityCap = rarity.charAt(0).toUpperCase() + rarity.slice(1);
  const biome = TILE_TYPES[tile.type]?.label || tile.type;

  bannerTileNameEl.innerHTML =
    `<span class="rarity-${rarity}">${rarityCap}</span> ${biome}`;
}

/* =======================
   MESSAGE BANNER TEMP POPUP
======================= */
function showMessageBanner(rarity, biome) {
  if (biome === "Home") {
    messageBannerEl.innerHTML = "Discovered Home!";
  } else {
    const rarityCap = rarity.charAt(0).toUpperCase() + rarity.slice(1);
    messageBannerEl.innerHTML =
      `Discovered <span class="rarity-${rarity}">${rarityCap}</span> ${biome}!`;
  }

  messageBannerEl.style.display = "block";
  requestAnimationFrame(() => {
    messageBannerEl.style.opacity = "1";
  });

  setTimeout(() => {
    messageBannerEl.style.opacity = "0";
    setTimeout(() => messageBannerEl.style.display = "none", 350);
  }, 1800);
}

/* =======================
   EXPLORE BUTTON
======================= */
function updateEnterButton() {
  const tile = getTile(playerX, playerY);
  if (!tile) return enterButtonEl.style.display = "none";
  enterButtonEl.textContent = "Explore";
  enterButtonEl.style.display = "inline-block";
}

enterButtonEl.addEventListener("click", () => {
  const tile = getTile(playerX, playerY);
  if (!tile) return;

  const rarity = tile.type === "home" ? "common" : tile.rarity || "common";

  localStorage.setItem("innerworld_entry", JSON.stringify({
    tile: { type: tile.type, rarity },
    playerStart: { x: 250, y: 250 }
  }));

  saveGame();
  window.location.href = "innerworld.html";
});

/* =======================
   GRID
======================= */
function initGridDOM() {
  gridEl.innerHTML = "";
  tileElements = [];

  for (let y=0; y<SIZE; y++){
    const row=[];
    for (let x=0; x<SIZE; x++){
      const d=document.createElement("div");
      d.className="tile";
      d.dataset.x=x;
      d.dataset.y=y;
      d.addEventListener("click", onTileClick);
      gridEl.appendChild(d);
      row.push(d);
    }
    tileElements.push(row);
  }

  gridEl.appendChild(playerSpriteEl);
}

function renderGrid() {
  const anyCards = canPlayAnyCard();

  for (let y=0; y<SIZE; y++){
    for (let x=0; x<SIZE; x++){
      const d = tileElements[y][x];
      const tile = world[y][x];

      d.className = "tile";
      d.style.backgroundImage = "";

      if (!tile) {
        // empty
      } else {
        const img = TILE_TYPES[tile.type]?.image;
        if (img) d.style.backgroundImage = `url('${img}')`;
      }

      if (!tile && anyCards && isAdjacent(x,y))
        d.classList.add("tile-highlight-playable");
    }
  }

  positionPlayerSprite();
}

function positionPlayerSprite() {
  const tile = tileElements[playerY]?.[playerX];
  if (!tile) return;

  const tileRect = tile.getBoundingClientRect();
  const gridRect = gridEl.getBoundingClientRect();

  const w = tileRect.width;
  const h = tileRect.height;

  const x = tileRect.left - gridRect.left;
  const y = tileRect.top - gridRect.top;

  playerSpriteEl.style.width = w+"px";
  playerSpriteEl.style.height = h+"px";

  const scaleX = playerFacing === -1 ? -1 : 1;

  playerSpriteEl.style.transform =
    `translate(${x}px, ${y}px) scaleX(${scaleX})`;
}

window.addEventListener("resize", positionPlayerSprite);

/* =======================
   TILE CLICK HANDLER
======================= */
function onTileClick(e){
  const x = parseInt(e.currentTarget.dataset.x);
  const y = parseInt(e.currentTarget.dataset.y);
  const tile = getTile(x,y);

  if (!tile && isAdjacent(x,y) && canPlayAnyCard()) {
    pendingTile = { x,y };
    selectedCardType = null;
    openCardOverlay("tile");
    return;
  }

  if (tile && isAdjacent(x,y)) {
    if (x < playerX) playerFacing = -1;
    if (x > playerX) playerFacing =  1;

    playerX=x; playerY=y;

    pendingTile=null;
    selectedCardType=null;
    closeCardOverlay();

    renderGrid();
    updateBanner();
    updateEnterButton();
    saveGame();
    return;
  }

  if (cardMenuOpen) closeCardOverlay();
}

/* =======================
   CARD OVERLAY / SELECT
======================= */
let cardElements=[];

function initCardsDOM(){
  cardOverlayCardsEl.innerHTML="";
  cardElements=[];

  for (const card of cards){
    const div=document.createElement("div");
    div.className="card";
    div.dataset.type=card.type;

    const img=document.createElement("img");
    img.src=card.image;

    const count=document.createElement("div");
    count.className="card-count";

    div.appendChild(img);
    div.appendChild(count);
    div.addEventListener("click", onOverlayCardClick);

    cardOverlayCardsEl.appendChild(div);
    cardElements.push({ type:card.type, el:div, countEl:count });
  }

  renderCards();
}

function renderCards(){
  for (const entry of cardElements){
    const data = getCard(entry.type);
    const hasAny = data && data.count>0;
    const isSel = (selectedCardType===entry.type);

    entry.countEl.textContent = data ? `x${data.count}` : `x0`;

    entry.el.classList.toggle("card-disabled", !hasAny);
    entry.el.classList.toggle("card-selected", hasAny && isSel);
  }
}

function openCardOverlay(reason){
  cardMenuOpen=true;
  cardOverlayEl.style.display="flex";

  if (reason==="tile" && pendingTile){
    cardOverlayTitleEl.textContent =
      `Select a card for (${pendingTile.x+1},${pendingTile.y+1})`;
  } else {
    cardOverlayTitleEl.textContent="Cards";
    pendingTile=null;
    selectedCardType=null;
  }

  renderCards();
}

function closeCardOverlay(){
  cardMenuOpen=false;
  cardOverlayEl.style.display="none";
  pendingTile=null;
  selectedCardType=null;
  renderCards();
}

cardToggleButtonEl.addEventListener("click",()=>{
  if (cardMenuOpen) closeCardOverlay();
  else openCardOverlay("manual");
});

cardOverlayCloseEl.addEventListener("click",closeCardOverlay);

function onOverlayCardClick(e){
  const type=e.currentTarget.dataset.type;
  const card=getCard(type);
  if (!card || card.count<=0) return;

  if (pendingTile && selectedCardType===type){
    placeCardOnPendingTile(type);
    return;
  }

  selectedCardType=type;
  renderCards();
}

/* =======================
   PLACE CARD
======================= */
function placeCardOnPendingTile(type){
  if (!pendingTile) return;
  const {x,y} = pendingTile;

  if (!isAdjacent(x,y)) return;
  if (getTile(x,y) !== null) return;

  const card=getCard(type);
  if (!card || card.count<=0) return;

  const rarity="common"; // placeholder until rarity system added

  world[y][x] = { type, rarity };

  card.count--;
  if (card.count<=0) selectedCardType=null;

  const biome = TILE_TYPES[type]?.label || type;
  showMessageBanner(type==="home" ? "common" : rarity, biome);

  pendingTile=null;

  saveGame();
  renderGrid();
  renderCards();
  updateBanner();
  updateEnterButton();
  closeCardOverlay();
}

/* =======================
   BOOTSTRAP
======================= */
function initUI(){
  initGridDOM();
  initCardsDOM();
  renderGrid();
  renderCards();
  updateBanner();
  updateEnterButton();
}

(function start(){
  const hasSave = loadGame();

  if (!hasSave){
    outerRoot.style.display="none";
    newGameScreen.style.display="flex";
    newGameButton.addEventListener("click",()=>{
      createFreshState();
      saveGame();
      newGameScreen.style.display="none";
      outerRoot.style.display="flex";
      initUI();
    });
  } else {
    outerRoot.style.display="flex";
    newGameScreen.style.display="none";
    initUI();
  }
})();
</script>
</body>
</html>
